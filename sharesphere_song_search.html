<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Sphere - Song search</title>
    <link rel="icon" href = "logo.jpg" type = "image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #search-section {
            margin-bottom: 20px;
        }
        #search-input {
            width: 300px;
            padding: 10px;
            font-size: 16px;
        }
        #search-button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        #results-section {
            margin-top: 20px;
        }
        #results-container {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #player
        {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #navbar {
            width: 100%;
            background-color: #001f3f;
            position: sticky;
            top: 0;
            left: 0;
            margin-bottom: 2px;
            z-index: 1000;
        }

        #nav-container {
            margin: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #name {
            display: flex;
            align-items: center;
        }

        #name span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #edf6f9;
        }

        #desktop-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 3.5rem;
            font-size: 0.8rem;
        }

        #desktop-nav a {
            color: #edf6f9;
            font-weight: 500;
            transition: color 0.5s ease;
            font-size: medium;
            text-decoration: none;
            font-size: 1.1rem;
        }

        #desktop-nav a:hover {
            color: #aff0e3;
        }

        #auth-buttons {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20%;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        #logout {
            background: #00b4d8;
            border: 2px solid #00b4d8;
            color: #edf6f9;
            font-size: 1rem;
            border-radius: 5px;
        }

        #logout:hover {
            background: #ff0000;
            color: #ffffff;
        }
        @media (min-width: 851px) {
            #auth-buttons {
                flex-direction: row;
                gap: 1rem;
            }
            #desktop-nav
            {
                display: flex;
                flex-direction: row;
                gap: 3.5rem;
            }
            #more{
                display: none ;
                border: 2px solid #edf6f9;
                padding: 4px;
                margin: 2px;
            }
        }
        @media (max-width: 850px) {
            #desktop-nav {
                display: none;
            }
            #more {
                display: block;
            }
            #nav-container{
                flex-direction: column;
            }
            #auth-buttons{
                flex-direction: column;
                gap: 0.2rem;
            }
        }
        #send-song-btn:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <nav id="navbar">
        <div id="nav-container">
            <div id="name">
                <span>Share Sphere</span>
            </div>
            <button id = "more">&#9776;</button>
            <div id="desktop-nav">
                <a href = "sharesphere_public_page.html">Home</a>
                <a href="sharesphere_your_account.html">Your Account</a>
                <a href="sharesphere_find_people.html">Find friends</a>
                <a href ="sharesphere_find_rooms.html">Join Room</a>
                <a href="sharesphere_about_us.html">About Us</a>
                <a href="sharesphere_feedback.html">Feedback</a>
            </div>

            <div id="auth-buttons">
                <button id="logout">Log Out</button>
            </div>
        </div>
    </nav>
    <h1>Search for a song</h1>
    <main>
        <div id = "search-section">
            <input type="text" id="search-input" placeholder="Search for songs...">
            <button id="search-button">Search</button>
        </div>
            <div id="player"></div>
    </main>
    <script type = "module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            sendEmailVerification
            } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
            import { getDatabase, ref, set, get, child, onValue, onChildAdded, push } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDXLWL-WySSNnRLL1khrnuWYnUE3-OF74",
            authDomain: "share-sphere-v-8.firebaseapp.com",
            databaseURL: "https://share-sphere-v-8-default-rtdb.firebaseio.com",
            projectId: "share-sphere-v-8",
            storageBucket: "share-sphere-v-8.firebasestorage.app",
            messagingSenderId: "931094139319",
            appId: "1:931094139319:web:4d202e258a5c4231ea9832",
            measurementId: "G-DKHQ2H23VM"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const fs = getFirestore(app);
        let auth = await getAuth(app);
        console.log(auth);

        more.addEventListener("click", moreclicked);
        function moreclicked()
        {
            let dnav = document.getElementById("desktop-nav");
            dnav.style.display = "flex";
            dnav.style.flexDirection = "column";
            dnav.style.gap = "0"
            more.style.display = "none";
        }

        let logoutbtn = document.getElementById("logout");
        logoutbtn.addEventListener("click", fnclogout);

        function fnclogout()
        {
            signOut(auth)
            .then(() => {
                window.location.href = "sharesphere_logout.html"
            }).catch((error) => {
                alert("Error occured while signing out, please try again later.")
            });
        }
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("You are not logged in!");
                window.location.href = "index.html";
            }
            if(user)
            {
            if(!user.emailVerified)
            {
                window.location.href = "sharesphere_emial_verify.html";
            }

            let fndemail = new URLSearchParams(window.location.search).get("fndemail");
            let useremailSafe = user.email.replace(/\./g, ",");
            let fndemailSafe = fndemail.replace(/\./g, ",");
            console.log(useremailSafe);
            console.log(fndemailSafe);
            if (fndemail)
            {
                let fndname = await getnamefromemail(fndemail);

                let send = document.createElement("button");
                send.innerText = "Send song to " + fndname;
                send.id = "send-song-btn";
                document.body.appendChild(send);
                send.style.bottom = "20px";
                send.style.right = "20px";
                send.style.backgroundColor = "#00b4d8";
                send.style.color = "#edf6f9";
                send.style.padding = "12px 20px";
                send.style.border = "none";
                send.style.borderRadius = "8px";
                send.style.cursor = "pointer";
                send.style.fontSize = "16px";
                send.style.fontWeight = "bold";
                send.marginTop = "20px";
                send.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
                send.style.transition = "background-color 0.3s ease, transform 0.2s ease";

                send.addEventListener("mouseover", () => {
                    send.style.backgroundColor = "#007bff";
                    send.style.transform = "scale(1.05)";
                });
                send.addEventListener("mouseout", () => {
                    send.style.backgroundColor = "#00b4d8";
                    send.style.transform = "scale(1)";
                });

                send.addEventListener("click", async() =>
            {
                let address;
                if (user.email > fndemail) {
                    address = `${useremailSafe}_${fndemailSafe}`;
                } else {
                    address = `${fndemailSafe}_${useremailSafe}`;
                }
                const chatRef = ref(db, `chats/${address}/messages`);
                let query = document.getElementById("search-input").value;
                if (!query) return alert("Please enter a song name");

                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=videoCategoryId=10&q=${encodeURIComponent(query)}&key=AIzaSyDjZng4T299cUjZGK2IIVRDloOZcNYO6HQ`;
                let response = await fetch(url);
                let data = await response.json();

                if (data.items.length > 0) {
                let videoId = data.items[0].id.videoId;
                console.log(videoId);
                const newMsg = push(chatRef);
                set(newMsg, {
                sender: user.email,
                songurl: videoId,
                timestamp: Date.now()
                })
                .then(() => {
                    window.location.href = "sharesphere_chat.html?fndemail=" + fndemail;
                });
                }
                else{
                    alert("No video found");
                    return;
                }
            });
            }
        }
        });
        async function getnamefromemail(email)
        {
            let name = "";
            await getDoc(doc(fs, "users", email)).then((docSnap) => {
                if (docSnap.exists()) {
                    name = docSnap.data().username;
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
            return name;
        }
         document.getElementById('search-button').addEventListener('click', function() {
            searchSong();
        });
    async function searchSong() {
        
      let query = document.getElementById("search-input").value;
      if (!query) return alert("Please enter a song name");

      let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&q=${encodeURIComponent(query)}&key=AIzaSyDjZng4T299cUjZGK2IIVRDloOZcNYO6HQ`;

      try {
        let response = await fetch(url);
        let data = await response.json();

        if (data.items.length > 0) {
            let i = 1;
            while (i<data.items.length)
            {
                if (data.items[i].id.videoId != data.items[0].id.videoId)
            {
                let videoId = data.items[0].id.videoId;
                 document.getElementById("player").innerHTML =
            `<iframe 
              src="https://www.youtube.com/embed/${videoId}?autoplay=1"
              frameborder="0" allow="autoplay; encrypted-media" allowfullscreen ></iframe>`;
            }
                i++;
            }
          let videoId = data.items[0].id.videoId;
         
        } else {
          alert("No video found");
        }
      } catch (err) {
        console.error(err);
        alert("Error fetching YouTube data");
      }
    }
    </script>
</body>
</html>
