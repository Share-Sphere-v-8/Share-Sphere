<html>
    <head>
        <title>Share Sphere - Sign In</title>
        <link rel="icon" href = "logo.jpg" type = "image/x-icon">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
            body {
                text-align: center;
                background: linear-gradient(135deg, #aff0e3 0%, #edf6f9 100%);
                font-family: 'Trebuchet MS';
                margin: 0px;
                padding: 0px;
            }
            h1 {
                text-align: center;
                color: #006d77;
                margin-top: 50px;
            }
            #box {
                width: 60%;
                max-width: 500px;
                margin: auto;
                padding: 40px;
                border-radius: 20px;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                border: 1px solid #e9ecef;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #signup-form {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .input-container {
                position: relative;
                width: 100%;
                margin: 15px 0;
            }
            input {
                width: 100%;
                padding: 15px 15px 15px 50px;
                border: 2px solid #ced4da;
                border-radius: 10px;
                font-size: medium;
                background-color: #ffffff;
                transition: border-color 0.3s ease, box-shadow 0.3s ease;
            }
            input:focus {
                border-color: #7DCFB6;
                box-shadow: 0 0 5px rgba(125, 207, 182, 0.5);
                outline: none;
            }
            .input-container i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #6c757d;
                font-size: 18px;
            }
            #submit {
                background: linear-gradient(135deg, #FC9F5B 0%, #e29578 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                cursor: pointer;
                font-size: large;
                font-weight: bold;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
                margin-top: 20px;
                width: 100%;
                max-width: 200px;
            }
            #submit:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }
            h2 {
                color: #006d77;
                margin-bottom: 30px;
            }
            a {
                color: #e29578;
                text-decoration: none;
                margin-top: 20px;
            }
            a:hover {
                text-decoration: underline;
            }
            #googleBtn {
            background-color: #ffffff;
            color: #3c4043;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 200px;
            margin-top: 20px;
        }
        #googleBtn i {
            color: #ea4335;
            font-size: 16px;
        }
        #googleBtn:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        </style>
    </head>
    <body>
        <h1>Share Sphere - Sign In</h1>
        <div id = "box">
            <h2>Welcome Back</h2>
            <button id="googleBtn"><i class="fab fa-google"></i> Continue with Google</button><br>
            <div style="margin: 10px; font-weight: bold; color: #6c757d;">OR</div>
            <form id="signup-form">
                <div id = "divemail">
                    <input type="email" id ="email" name = "email" placeholder = "Email" required>
                </div><br>
                <div id = "divpassword">
                    <input type = "password" id = "password" name = "password" placeholder = "Password" required>
                </div><br>
                <br><br>
                <input type="submit" id = "submit" value="Sign In">
                <div id ="dontacc" style="margin-top: 20px;"><a href = "sharesphere_sign_up.html">Don't have an account? Click here to sign up</a></div>
            </form>
        </div>
        <footer style="text-align: center; padding: 20px; color: rgba(255,0,0,0.7); font-size: 0.9rem; margin-top: 50px;">
            Â© 2025 Share Sphere - Copyrights reserved 
        </footer>
    </body>
    <script type="module">
        import { getAuth, GoogleAuthProvider, 
        signInWithPopup,
        fetchSignInMethodsForEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import {
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyBDXLWL-WySSNnRLL1khrnuWYnUE3-OF74",
            authDomain: "share-sphere-v-8.firebaseapp.com",
            databaseURL: "https://share-sphere-v-8-default-rtdb.firebaseio.com",
            projectId: "share-sphere-v-8",
            storageBucket: "share-sphere-v-8.firebasestorage.app",
            messagingSenderId: "931094139319",
            appId: "1:931094139319:web:4d202e258a5c4231ea9832",
            measurementId: "G-DKHQ2H23VM"
        };
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        let auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        document.getElementById("googleBtn").addEventListener("click", () => {

    signInWithPopup(auth, provider)
      .then(async (result) => {

        const user = result.user;

        // STORE USER INFO IN VARIABLES
        const userName = user.displayName;
        const userEmail = user.email;
        const userPhoto = user.photoURL;
        const userUID = user.uid;

        await updateDoc(doc(db, "users", userEmail),
        {
            username: userName,
            email:userEmail,
            friends: 0,
            pfpUrl: userPhoto,
            friendlist: [],
            friendrequestsreceived: [],
            friendrequestssent: [],
            timestap: new Date()
        });
        const loginMethod = user.providerData[0].providerId;  
        console.log("Name:", userName);
        console.log("Email:", userEmail);
        console.log("Photo:", userPhoto);
        console.log("UID:", userUID);
        console.log("Login Method:", loginMethod);
        window.location.href = "sharesphere_public_page.html";

      })
      .catch(async (error) => {

        if (error.code === "auth/account-exists-with-different-credential") {
          const email = error.customData.email;
          const methods = await fetchSignInMethodsForEmail(auth, email);

          if (methods.includes("password")) {
            alert("You already created an account using Email/Password. Please log in using email.");
          }
        } else {
          console.error(error);
        }

      });

  });

        let submit = document.getElementById("signup-form");
        submit.addEventListener ("submit", signin);
        function signin(event){
            event.preventDefault();
            let email = document.getElementById("email").value;
            let password = document.getElementById("password").value;
            signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                let user = userCredential.user;
                let db = getFirestore(app);
                getDoc(doc(db, "users", email))
                .then((docSnapshot) => {
                    if (docSnapshot.exists()) {
                        let name = docSnapshot.data().username
                        alert(`Welcome back ${name} `);
                        window.location.href = "#";
                    }
                })
                .catch((error) => {
                    alert("Error fetching user data:", error.message);
                });
            })
            .catch((error) => {
                alert("Error occured while logging in, check weather the entered email id and password are correct or not");
            });
        }
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.location.href = "sharesphere_public_page.html"
            }
        });
      </script>
      <script>
        testSpeed();
async function testSpeed() {
    const fileUrl = "https://speed.cloudflare.com/__down?bytes=1000000";
    const fileSize = 1 * 1024 * 1024; // 1MB in bytes

    const startTime = performance.now();

    try {
        const response = await fetch(fileUrl, { cache: "no-store" });
        await response.blob(); // Wait for file to fully download
    } catch (e) {
        alert("Connect to a better internet connection to continue using our application");
        window.location.href = "index.html";
    }

    const endTime = performance.now();
    const durationInSeconds = (endTime - startTime) / 1000;

    const speedBps = fileSize / durationInSeconds;        // bytes per second
    const speedMbps = (speedBps * 8) / (1024 * 1024);     // convert to Mbps

    if (speedMbps < 0.1)
    {
        alert("Connect to a better internet connection to continue using our application");
        window.location.href = "index.html";
    }
    else if (speedMbps < 0.5)
    {
        alert("Looks like you have a slow internet connection, some of the fetures might not work properly!");
    }
}
</script>
</html>
